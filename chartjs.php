<?php
$list = [
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"ITEM-111", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"ITEM-112", "QTY"=>"2"],
    ["WORK"=>"2", "CATEGORY"=>"Category 1", "ITEM_CD"=>"ITEM-113", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"ITEM-111", "QTY"=>"4"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"ITEM-113", "QTY"=>"5"],
    ["WORK"=>"1", "CATEGORY"=>"Category 3", "ITEM_CD"=>"ITEM-111", "QTY"=>"3"],
    ["WORK"=>"2", "CATEGORY"=>"Category 1", "ITEM_CD"=>"ITEM-111", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"ITEM-111", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"２ITEM-111", "QTY"=>"4"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"2ITEM-112", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 5", "ITEM_CD"=>"ITEM-114", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"12ITEM-111", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"1ITEM-113", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"1ITEM-114", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 3", "ITEM_CD"=>"1ITEM-111", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 5", "ITEM_CD"=>"1ITEM-112", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"1ITEM-113", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"1ITEM-112", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 3", "ITEM_CD"=>"1ITEM-111", "QTY"=>"4"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"1ITEM-112", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"1ITEM-12", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"1ITEM-13", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"1ITEM-13", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 5", "ITEM_CD"=>"1ITEM-12", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"1ITEM-12", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"1ITEM-12", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"1ITEM-13", "QTY"=>"2"],
    ["WORK"=>"1", "CATEGORY"=>"Category 3", "ITEM_CD"=>"1ITEM-12", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 4", "ITEM_CD"=>"1ITEM-12", "QTY"=>"3"],
    ["WORK"=>"1", "CATEGORY"=>"Category 3", "ITEM_CD"=>"1ITEM-01", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 2", "ITEM_CD"=>"1ITEM-02", "QTY"=>"1"],
    ["WORK"=>"1", "CATEGORY"=>"Category 1", "ITEM_CD"=>"1ITEM-03", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-01", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-02", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-03", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-04", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-05", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-06", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-07", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-08", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-09", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-10", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-11", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-12", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-13", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-14", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-15", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-16", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-17", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-18", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-19", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-20", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-21", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-22", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-23", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-24", "QTY"=>"1"],
    ["CATEGORY"=>"Cat1", "ITEM_CD"=>"ITEM-25", "QTY"=>"1"],
];

//縦軸の項目用
$categorys = [];
foreach ($list as $value) {
    $key = $value['WORK'].':'.$value['CATEGORY'];
    $categorys = array_unique(array_merge(array($key), $categorys));
}
// $categorys = array_unique(array_column($list, "CATEGORY"));
// sort($categorys);
usort($categorys, "strnatcmp");

//品目用
$items = array_unique(array_column($list, "ITEM_CD"));
usort($items, "strnatcmp");

//表示用: $datas[品目]["CATEGORY"=>カテゴリ, "QTY"=>数量の合計] 
$datas = [];
foreach ($categorys as $category) {
    $sum = 0;
    foreach ($items as $itemCd) {
        $qty = 0;
        foreach ($list as $value) {
            $key = $value['WORK'].':'.$value['CATEGORY'];
            if ($key == $category && $value["ITEM_CD"] == $itemCd) {
            // if ($value["CATEGORY"] == $category && $value["ITEM_CD"] == $itemCd) {
                $qty += $value["QTY"];
            }
        }
        $datas[$itemCd][] = ["CATEGORY" => $category, "QTY" => $qty];
    }
}

// echo('<pre>');
// print_r($categorys);
// echo('</pre>');

// $strings = array("12A", "1A", "3B", "2C", "１０００", "５００");
// $collator = new Collator('ja_JP'); // ロケールを指定
// usort($strings, function($a, $b) use ($collator) {
//     return $collator->compare($a, $b);
// });
// print_r($strings);
?>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart.js</title>
    <style>
        body {
            background-color: #f0f0f0;
            margin: 0;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .canvas-container50 {
            width: 50%;
            height: 500px;
        }
        .canvas-container100 {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <div style="text-align: center;">
        <input type="checkbox" id="toggleCheckbox1" onchange="toggleChartVisibility('myChartDiv1')" checked>
        <label for="toggleCheckbox1">Chart1</label>
        <input type="checkbox" id="toggleCheckbox2" onchange="toggleChartVisibility('myChartDiv2')" checked>
        <label for="toggleCheckbox2">Chart2</label>
        <select name="selectChart2" id="selectChart2">
            <option value="bar">棒グラフ</option>
            <option value="pie">円グラフ</option>
        </select>
        <input type="checkbox" id="toggleCheckbox3" onchange="toggleChartVisibility('myChartDiv3')" checked>
        <label for="toggleCheckbox3">Chart3</label>
        <button onclick="saveCharts()">Save Charts as Image</button>
    </div>

    <div class="container" id="parentCanvas">
        <div class="canvas-container50" id="myChartDiv1">
            <canvas id="myChart1"></canvas>
        </div>
        <div class="canvas-container50" id="myChartDiv2">
            <canvas id="myChart2"></canvas>
        </div>
    </div>
    <div class="container">
        <div class="canvas-container100" id="myChartDiv3">
            <canvas id="myChart3"></canvas>
        </div>
    </div>
    <!-- <div class="container" id="parentCanvas">
        <div class="canvas-container50" id="myChartDiv4">
            <canvas id="myChart4"></canvas>
        </div>
        <div class="canvas-container50" id="myChartDiv5">
            <canvas id="myChart5"></canvas>
        </div>
    </div> -->
    

    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        const customCanvasBackgroundColor = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart, args, options) => {
                const {ctx} = chart;
                ctx.save();
                // 枠線
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'gray';
                ctx.strokeRect(0, 0, chart.width, chart.height);
                // 背景色
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        const colors = [
            "rgba(246, 185, 59, 1.0)",
            "rgba(159, 189, 225,1.0)",
            "rgba(255, 234, 167,1.0)",
            "rgba(184, 233, 148,1.0)",
            "rgba(130, 204, 221,1.0)",

            "rgba(250, 211, 144,1.0)",
            "rgba(250, 177, 160,1.0)",
            "rgba(135, 206, 250,1.0)",
            "rgba(248, 194, 145,1.0)",
            "rgba(120, 224, 143,1.0)",

            "rgba(255, 228, 181,1.0)",
            "rgba(222, 184, 135,1.0)",
            "rgba(176, 224, 230,1.0)",
            "rgba(221, 218, 235,1.0)",
            "rgba(123, 237, 159,1.0)",

            "rgba(236, 204, 104,1.0)",
            "rgba(216, 191, 216,1.0)",
            "rgba(178, 190, 195,1.0)",
            "rgba(255, 204, 204,1.0)",
            "rgba(173, 216, 230,1.0)",
        ];
        
        var chart2;
        function drawChart2(chartType) {
            var displayLabel = true;
            if (chartType == 'bar') {
                displayLabel = false;
            }
            const ctx2 = document.getElementById('myChart2').getContext('2d');
            if (chart2) {
                chart2.destroy();
            }
            // const chart2 = new Chart(ctx2, {
            chart2 = new Chart(ctx2, {
                type: chartType,
                data: {
                    labels: ['Red', 'Orange', 'Yellow', 'Green', 'Blue'],
                    datasets: [
                        {
                            label: 'Dataset 1',
                            data: [10, 30, 20, 40, 60],
                            backgroundColor: [
                                colors[0],
                                colors[1],
                                colors[2],
                                colors[3],
                                colors[4],
                            ]
                        },
                    ]
                },
                plugins: [
                    ChartDataLabels,
                    {
                        beforeDraw: (chart, args, options) => {
                            const {ctx} = chart;
                            ctx.save();
                            // 枠線
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = 'gray';
                            ctx.strokeRect(0, 0, chart.width, chart.height);
                            // 背景色
                            ctx.globalCompositeOperation = 'destination-over';
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, chart.width, chart.height);
                            ctx.restore();
                        }
                    }
                ],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            // display: false  // 凡例を非表示にする
                            display: displayLabel
                        },
                    }
                }
            });
        }

        const ctx1 = document.getElementById('myChart1').getContext('2d');
        const chart1 = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: '# of Votes',
                    data: [12, 19, 3, 5, 2, 3],
                    borderWidth: 1,
                }]
            },
            plugins: [
                ChartDataLabels,
                {
                    beforeDraw: (chart, args, options) => {
                        const {ctx} = chart;
                        ctx.save();
                        // 枠線
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = 'gray';
                        ctx.strokeRect(0, 0, chart.width, chart.height);
                        // 背景色
                        ctx.globalCompositeOperation = 'destination-over';
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, chart.width, chart.height);
                        ctx.restore();
                    }
                }
            ],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    datalabels: {
                        color: '#36A2EB',
                        backgroundColor: 'rgba(255,255,255,0.5)',
                        formatter: function(value) {
                            return value + "件";
                        }
                    },
                    title: {
                        display: true,
                        text: 'title'
                    }                    
                }
            }
        });

        var selectChart2 = document.getElementById('selectChart2').value;
        drawChart2(selectChart2);

        const ctx3 = document.getElementById('myChart3').getContext('2d');
        new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: [
                    <?php foreach($categorys as $category) {
                        echo "'".$category."',";
                    }?>
                ],
                datasets: [
                    <?php
                    $idx = 0;
                    foreach($datas as $itemCd => $value) {
                        echo "{";
                        echo    "label:'".$itemCd."',";
                        echo    "data:[";
                                    foreach ($value as $item) {
                                        echo $item["QTY"].",";
                                    }
                        echo    "],";
                        echo    "backgroundColor: colors[".($idx%20)."],";
                        echo "},";
                        // echo <<< EOM
                        //     {
                        //         label: '{$itemCd}',
                        //         data: [
                        // EOM;
                        //             foreach ($value as $item) {
                        //                 echo $item['QTY'].',';
                        //             }
                        // echo <<< EOM
                        //         ],
                        //         backgroundColor: colors[{$idx}],
                        //     },
                        // EOM;
                        $idx++;
                        // $idx %= 20;
                    }?>
                ]
            },
            plugins: [
                ChartDataLabels,
                customCanvasBackgroundColor,
            ],
            options: {
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            stepSize: 1
                        },
                    },
                    y: {
                        stacked: true,
                    }
                },
                plugins: {
                    datalabels: {
                        formatter: function(value) {
                            if (value != 0) {
                                return value + "件";
                            } else {
                                return "";
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'title'
                    }                    
                }
            }
        });

        // const ctx4 = document.getElementById('myChart4').getContext('2d');
        // new Chart(ctx4, {
        //     type: 'bar',
        //     data: {
        //         labels: ['Category 1', 'Category 2', 'Category 3'],
        //         datasets: [
        //             {
        //                 label: 'Dataset 1',
        //                 data: [10, 20, 30],
        //                 // backgroundColor: 'rgba(255, 99, 132, 0.7)',
        //                 stack: 'stack-1',
        //             },
        //             {
        //                 label: 'Dataset 2',
        //                 data: [15, 25, 35],
        //                 // backgroundColor: 'rgba(54, 162, 235, 0.7)',
        //                 stack: 'stack-1',
        //             },
        //             {
        //                 label: 'Dataset 3',
        //                 data: [20, 30, 40],
        //                 // backgroundColor: 'rgba(255, 206, 86, 0.7)',
        //                 stack: 'stack-1',
        //             },
        //         ],
        //     },
        //     plugins: [
        //         ChartDataLabels,
        //         {
        //             beforeDraw: (chart, args, options) => {
        //                 const {ctx} = chart;
        //                 ctx.save();
        //                 // 枠線
        //                 ctx.lineWidth = 2;
        //                 ctx.strokeStyle = 'gray';
        //                 ctx.strokeRect(0, 0, chart.width, chart.height);
        //                 // 背景色
        //                 ctx.globalCompositeOperation = 'destination-over';
        //                 ctx.fillStyle = 'white';
        //                 ctx.fillRect(0, 0, chart.width, chart.height);
        //                 ctx.restore();
        //             }
        //         }
        //     ],
        //     options: {
        //         maintainAspectRatio: false,
        //         indexAxis: 'y',
        //         scales: {
        //             x: {
        //                 stacked: true,
        //             },
        //             y: {
        //                 stacked: true,
        //             }
        //         }
        //     }
        // });

        // チェックボックスでのグラフの表示切替
        function toggleChartVisibility(divId) {
            var checkbox = document.getElementById('toggleCheckbox' + divId.slice(-1));
            var myDiv = document.getElementById(divId);
            // チェックボックスがチェックされている場合はdivを表示、それ以外は非表示にする
            myDiv.style.display = checkbox.checked ? 'block' : 'none';
        }

        // 表示しているグラフの画像を保存
        function saveCharts() {
            var parentCanvas = document.getElementById('parentCanvas');
            var childCanvas1 = document.getElementById('myChart1');
            var childCanvas2 = document.getElementById('myChart2');
            var childCanvas3 = document.getElementById('myChart3');

            var toggleCheckbox1 = document.getElementById('toggleCheckbox1');
            var toggleCheckbox2 = document.getElementById('toggleCheckbox2');
            var toggleCheckbox3 = document.getElementById('toggleCheckbox3');

            if (toggleCheckbox1.checked || toggleCheckbox2.checked || toggleCheckbox3.checked) {
                // 新しいCanvasを作成
                var mergedCanvas = document.createElement('canvas');
                mergedCanvas.width = parentCanvas.offsetWidth;
                if ((toggleCheckbox1.checked || toggleCheckbox2.checked) && toggleCheckbox3.checked) {
                    mergedCanvas.height = childCanvas1.height + childCanvas3.height;
                } else {
                    mergedCanvas.height = childCanvas1.height;
                }
                var mergedContext = mergedCanvas.getContext('2d');

                var positionY = 0;

                // Chart1とChart2を描画
                if (toggleCheckbox1.checked && toggleCheckbox2.checked) {
                    mergedContext.drawImage(childCanvas1, 0, 0);
                    mergedContext.drawImage(childCanvas2, childCanvas1.width, 0);
                    positionY = childCanvas1.height;
                } else if (toggleCheckbox1.checked) {
                    mergedContext.drawImage(childCanvas1, parentCanvas.offsetWidth/4, 0);
                    positionY = childCanvas1.height;
                } else if (toggleCheckbox2.checked) {
                    mergedContext.drawImage(childCanvas2, parentCanvas.offsetWidth/4, 0);
                    positionY = childCanvas1.height;
                }

                // Chart3を描画
                if (toggleCheckbox3.checked) {
                    if (toggleCheckbox1.checked || toggleCheckbox2.checked) {
                        mergedContext.drawImage(childCanvas3, 0, positionY);
                    } else {
                        mergedContext.drawImage(childCanvas3, 0, 0);
                    }
                    positionY += childCanvas1.height;
                }

                // alert(positionY);
                // Chart4と続く...描画位置の高さは、positionY～

                mergedCanvas.toBlob(function (blob){
                    var item = new ClipboardItem({ 'image/png': blob });
                    navigator.clipboard.write([item]).then(function () {
                        console.log('画像がクリップボードにコピーされました。');
                        alert('表示されているすべてのグラフの画像をクリップボードにコピーしました。');
                    }).catch(function (error) {
                        console.error('クリップボードへのコピーに失敗しました:', error);
                    });
                });

            } else {
                alert("グラフが表示されていません。");
                exit();
            }

            // // 新しいCanvasを作成
            // var mergedCanvas = document.createElement('canvas');
            // mergedCanvas.width = parentCanvas.offsetWidth;
            // // mergedCanvas.width = childCanvas1.width + childCanvas2.width;
            // // mergedCanvas.width = childCanvas3.width;
            // mergedCanvas.height = childCanvas1.height + childCanvas3.height;
            // var mergedContext = mergedCanvas.getContext('2d');

            // // 1つ目のCanvasを描画
            // mergedContext.drawImage(childCanvas1, 0, 0);
            // // 1つ目のCanvasを描画（1つだけ真ん中に表示）
            // // mergedContext.drawImage(childCanvas1, parentCanvas.offsetWidth/4, 0);

            // // 2つ目のCanvasを描画
            // mergedContext.drawImage(childCanvas2, childCanvas1.width, 0);

            // // 3つ目のCanvasを描画
            // mergedContext.drawImage(childCanvas3, 0, childCanvas1.height);

            // // 画像として保存または表示できます
            // // var img = new Image();
            // // img.src = mergedCanvas.toDataURL('image/png');

            // // 例: 画像を表示
            // // document.body.appendChild(img);

            // mergedCanvas.toBlob(function (blob){
            //     var item = new ClipboardItem({ 'image/png': blob });
            //     navigator.clipboard.write([item]).then(function () {
            //         console.log('画像がクリップボードにコピーされました。');
            //         alert('表示されているすべてのグラフの画像をクリップボードにコピーしました。');
            //     }).catch(function (error) {
            //         console.error('クリップボードへのコピーに失敗しました:', error);
            //     });
            // });
        }
    </script>

    <script>
        $(function(){
            $('#selectChart2').on('change', function(){
                var chartType = $(this).val();
                drawChart2(chartType);
            });
        });
    </script>
</body>
</html>
